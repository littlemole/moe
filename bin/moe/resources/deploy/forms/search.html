<html>
 <head>
  <title>RegEx Find in Files</title>
  <style type="text/css">
 /* Style the tab */

form {
  padding:0px;
  margin:0px;
}
.tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
}

/* Style the buttons that are used to open the tab content */
.tab button {
  background-color: inherit;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
}

/* Change background color of buttons on hover */
.tab button:hover {
  background-color: #ddd;
}

/* Create an active/current tablink class */
.tab button.active {
  background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
  display: none;
  padding: 6px 0px;
  border: 1px solid #ccc;
  border-top: none;
} 

.moe {

  background-color: #F0F0F0;
  padding:2px;
  margin:3px;
}
  </style>
 </head>

 <body>

	<div class="tab">
	  <button class="tablinks active" onclick="showPane(event,'pane1')">active file</button>
	  <button class="tablinks" onclick="showPane(event,'pane2')">all files</button>
	</div>

	<!-- Tab content -->
	<div id="pane1" class="tabcontent active" style="display:block;">
       regex search active file
      <br>
	  <form name="theForm" action="#" onSubmit="return onSearch();">
      <input id="what" name="what" type="text" value="" size="35">
	  <input type="submit" value="Search" >
      <br>
      <br>
	  <input id="word" name="word" type="checkbox" >whole word
	  <input id="case" name="case" type="checkbox" >caseless
	  <br>
	  <div id="results" 
		   style="padding:0px;margin:8px 0px;overflow-y:scroll;height:45%;word-wrap:break-word">
	   <a name="result" ></a>
 	  </div>
      </form>
      <br>

	</div>

	<div id="pane2" class="tabcontent">
       regex search in all open files
      <br><br>
	  <form name="theFormAll" action="#" onSubmit="return onSearchAll();">
      <input id="whatAll" name="whatAll" type="text" value=""  size="35">
	  <input type="submit" value="Search" >
      <br>
      <br>
	  <input id="wordAll" name="wordAll" type="checkbox" >whole word
	  <input id="caseAll" name="caseAll" type="checkbox" >caseless
	  <br>
	  <div id="resultsAll" 
		   style="padding:0px;margin:8px 0px;overflow-y:scroll;height:45%;word-wrap:break-word">
	   <a name="resultAll" ></a>
	  </div>
	  </form>
      <br>
	</div>

    
    </div>
 </body>

<script language="javascript">

function onSearch()
{
  var what    = document.getElementById("what").value;
  var word    = document.getElementById("word").checked;
  var useCase = document.getElementById("case").checked;
  var results = document.getElementById("results");
  
  if ( !what || what == "" )
    return false;

  var name = window.chrome.webview.hostObjects.sync.external.Moe.ActiveDoc.FilePath;
  var sci = window.chrome.webview.hostObjects.sync.external.Moe.ActiveDoc.Model;
  if ( sci )
  {
    var txt = "" + sci.Text.GetText();
	var pos = 0;
	var p   = 0;
	var s   = what;
	var flags = "g";

	if ( useCase )
		flags += "i";

	if ( word )
		s = "\\b" + what + "\\b";

	var s = new RegExp ( s, flags  );
	var out = "<small><b>filename: " + sci.Properties.Filename + "</b></small>";

	while ( -1 != ( p = txt.substring(pos).search(s) ) )
	{

	  var line   = sci.Line.LineFromPos(pos+p);
	  var linend = sci.Line.LineEndPos(line);
	  var start  = pos+p;
	  var end    = pos+p+what.length;
      var m = txt.substring(start,end);
	  out += "<div class='moe'><a class='moe' href='#result' ";
	  out += "onClick='JumpTo(";
	  out += start + ", " + end;
	  out += ");'><b>";
	  out += " line: " + line;
	  out += "</b></a><small class='moe'>";
	  
	  var l = htmlEncode(sci.Line.LineText(line));
	  var r = new RegExp( what, flags  );
	  l = l.replace( s, "<i class='match'>" + what + "</i>" );
	  out += l;
	  out += "</small></div>\r\n";

	  pos = end+1;
	}
//alert(out);
	results.innerHTML = out;
  }
  return false;
}


function onSearchAll()
{
  var what    = document.getElementById("whatAll").value;
  var word    = document.getElementById("wordAll").checked;
  var useCase = document.getElementById("caseAll").checked;
  var results = document.getElementById("resultsAll");

  if ( !what || what == "" )
    return false;

  var out = "";

  for ( i = 0; i < window.chrome.webview.hostObjects.sync.external.Moe.Documents.Count; i++ )
  {
    var doc = window.chrome.webview.hostObjects.sync.external.Moe.Documents(i);
    if ( doc.type == 1 )
	{
	  var sci = doc.Model;
	  var txt = sci.Text.GetText();
	  var pos = 0;
	  var p   = 0;
	  var s   = what;

	  var flags = "g";

	  if ( useCase )
		flags += "i";

	  if ( word )
	    s = "\\b" + what + "\\b";

	  var s = new RegExp ( s, flags  );


	  out += "<small><b>filename: " + sci.Properties.Filename + "</b></small>";
	
	  while ( -1 != ( p = txt.substring(pos).search(s) ) )
	  {
		var line   = sci.Line.LineFromPos(pos+p);
		var linend = sci.Line.LineEndPos(line);
		var start  = pos+p;
		var end    = pos+p+what.length;
		var m = txt.substring(start,end);
		out += "<div class='moe'><a class='moe' href='#result' ";
		out += "onClick='GoTo( " + i + ", " + start;
		out += ", " + end + ")' ><b>";
		out += " line: " + line;
		out += "</b></a><small class='moe'>";
		
		var l = htmlEncode(sci.Line.LineText(line));
		var r = new RegExp( what, flags  );
		l = l.replace( s, "<i class='match'>" + what + "</i>" );
		out += l;
		out += "</small></div>\r\n";
		
  	    pos = end+1;
			
	  } // end while search
	} // endif docType == 1
  } // end for docs

  //alert(out);
  results.innerHTML = out;
  return false;
}

function JumpTo(  start, end )
{
	var d = window.chrome.webview.hostObjects.sync.external.Moe.ActiveDoc;
	if ( d )
	{
		if ( d.Type == 1 )
		{
			d.View.Activate();
			var sci = d.Model;
			sci.Selection.SetSelection( start, end );
			sci.Position.ScrollIntoView();
		}
	}
}

function GoTo( index, start, end )
{
	var d = window.chrome.webview.hostObjects.sync.external.Moe.Documents(index);
	if ( d )
	{
		if ( d.Type == 1 )
		{
			d.View.Activate();
			var sci = d.Model;
			sci.Selection.SetSelection( start, end );
			sci.Position.ScrollIntoView();
		}
	}
}


function showPane(evt, cityName) {
  // Declare all variables
  var i, tabcontent, tablinks;

  // Get all elements with class="tabcontent" and hide them
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  // Get all elements with class="tablinks" and remove the class "active"
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  // Show the current tab, and add an "active" class to the button that opened the tab
  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " active";
} 

function htmlEncode(source, display, tabs)
{
	function special(source)
	{
		var result = '';
		for (var i = 0; i < source.length; i++)
		{
			var c = source.charAt(i);
			if (c < ' ' || c > '~')
			{
				c = '&#' + c.charCodeAt() + ';';
			}
			result += c;
		}
		return result;
	}
	
	function format(source)
	{
		// Use only integer part of tabs, and default to 4
		tabs = (tabs >= 0) ? Math.floor(tabs) : 4;
		
		// split along line breaks
		var lines = source.split(/\r\n|\r|\n/);
		
		// expand tabs
		for (var i = 0; i < lines.length; i++)
		{
			var line = lines[i];
			var newLine = '';
			for (var p = 0; p < line.length; p++)
			{
				var c = line.charAt(p);
				if (c === '\t')
				{
					var spaces = tabs - (newLine.length % tabs);
					for (var s = 0; s < spaces; s++)
					{
						newLine += ' ';
					}
				}
				else
				{
					newLine += c;
				}
			}
			// If a line starts or ends with a space, it evaporates in html
			// unless it's an nbsp.
			newLine = newLine.replace(/(^ )|( $)/g, '&nbsp;');
			lines[i] = newLine;
		}
		
		// re-join lines
		var result = lines.join('<br />');
		
		// break up contiguous blocks of spaces with non-breaking spaces
		result = result.replace(/  /g, ' &nbsp;');
		
		// tada!
		return result;
	}

	var result = source;
	
	// ampersands (&)
	result = result.replace(/\&/g,'&amp;');

	// less-thans (<)
	result = result.replace(/\</g,'&lt;');

	// greater-thans (>)
	result = result.replace(/\>/g,'&gt;');
	
	if (display)
	{
		// format for display
		result = format(result);
	}
	else
	{
		// Replace quotes if it isn't for display,
		// since it's probably going in an html attribute.
		result = result.replace(new RegExp('"','g'), '&quot;');
	}

	// special characters
	result = special(result);
	
	// tada!
	return result;
}

</script>


</html>

